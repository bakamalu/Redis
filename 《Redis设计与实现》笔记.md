[toc]
# 《Redis设计与实现》
## 第二章.简单动态字符串
### SDS
SDS:Redis中用来替代C字符串的数据类型。  
定义:
```
struct sdshdr
{
    //已使用字节长度
    int len;
    //未使用字节数量
    int free;
    //用于保护字符串的字节数组
    char buf[];
}
```

### SDS与C字符串
#### SDS可使用一部分<string.h>库函数
SDS中数据放在buf中,同时其末尾为'\0'，所以我们可以直接使用C函数:  

```
printf("%s",s->buf);
```
也因此，可使用部分sting.h库中函数
#### len 时间复杂度O(1)
SDS用len记录存放数据长度，故获取其长度时间复杂度为O(1);  
#### SDS杜绝缓冲区溢出
SDS杜绝缓冲区溢出:
```
C字符串使用strcat将两个字符串拼接时，需要先为第一个参数字符串分配足够空间，否则可能导致缓冲区溢出(buffer overflow).  
而SDS杜绝了这种可能:SDS API需要对SDS进行修改时，API检查SDS的内存空间，如果不足会自动帮其扩展至修改所需大小。
SDS用于拼接的API:sdscat
```
#### free 减少内存重分配次数
1.空间预分配:减少重分配次数  
对一个SDS进行修改并需要对其进行空间扩展时，会为其分配额外未使用空间
```
若len将小于1MB,分配等同len大小的未使用空间

若len大于等于1MB,分配1MB的未使用空间

如len为30MB:
分配:30MB+1MB+1byte (1byte:'\0')
```
2.惰性空间释放  
缩短字符串长度时，不立即内存重分配，而是保留至free长度未释放空间，避免了内存重分配且为可能的增长操作提供优化。 
(有需要时，可真正释放SDS未使用空间)
#### SDS二进制安全
SDS的API二进制安全，所以SDS API以处理二进制的方式处理SDS存放在buf数组中的数据，而不会对其进行限制、过滤，所以SDS的buf属性也称字节数组。

#### SDS API

|函数|作用|时间复杂度|
| --- | --- | --- |
sdsnew|创建一个包含给定 C 字符串的 SDS 。|O(N) ， N 为给定 C 字符串的长度。
sdsempty|创建一个不包含任何内容的空 SDS 。|O(1)
sdsfree|释放给定的 SDS 。|O(1)
sdslen|返回 SDS 的已使用空间字节数。|这个值可以通过读取 SDS 的 len 属性来直接获得， 复杂度为 O(1) 。
sdsavail|返回 SDS 的未使用空间字节数。|这个值可以通过读取 SDS 的 free 属性来直接获得， 复杂度为 O(1) 。
sdsdup|创建一个给定 SDS 的副本（copy）。|O(N) ， N 为给定 SDS 的长度。
sdsclear|清空 SDS 保存的字符串内容。|因为惰性空间释放策略，复杂度为 O(1) 。
sdscat|将给定 C 字符串拼接到 SDS 字符串的末尾。|O(N) ， N 为被拼接 C 字符串的长度。
sdscatsds|将给定 SDS 字符串拼接到另一个 SDS 字符串的末尾。|O(N) ， N 为被拼接 SDS 字符串的长度。
sdscpy|将给定的 C 字符串复制到 SDS 里面， 覆盖 SDS 原有的字符串。|O(N) ， N 为被复制 C 字符串的长度。
sdsgrowzero|用空字符将 SDS 扩展至给定长度。|O(N) ， N 为扩展新增的字节数。
sdsrange|保留 SDS 给定区间内的数据， 不在区间内的数据会被覆盖或清除。|O(N) ， N 为被保留数据的字节数。
sdstrim|接受一个 SDS 和一个 C 字符串作为参数， 从 SDS 左右两端分别移除所有在 C 字符串中出现过的字符。|O(M*N) ， M 为 SDS 的长度， N 为给定 C 字符串的长度。
sdscmp|对比两个 SDS 字符串是否相同。|O(N) ， N 为两个 SDS 中较短的那个 SDS 的长度。
